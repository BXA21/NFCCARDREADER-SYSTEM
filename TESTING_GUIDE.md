# NFC Attendance System - Complete Testing Guide

## ğŸš€ Quick Start

### 1. Initialize the Backend

```bash
cd backend

# Create virtual environment (if not already created)
python -m venv venv

# Activate virtual environment
# Windows PowerShell:
.\venv\Scripts\Activate.ps1
# Windows CMD:
.\venv\Scripts\activate.bat
# Linux/Mac:
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Initialize database and create test data
python init_system.py
```

This will create:
- âœ… Database tables
- âœ… Admin user (admin / Admin@123)
- âœ… Test employee (EMP-001 / Employee@123)
- âœ… Test device with API key (note the API key!)

### 2. Start the Backend Server

```bash
cd backend
.\venv\Scripts\Activate.ps1  # or source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Backend will be available at: http://localhost:8000
API docs: http://localhost:8000/docs

### 3. Start the Frontend

```bash
cd frontend
npm install
npm run dev
```

Frontend will be available at: http://localhost:5173

### 4. Configure and Start the Reader Agent

```bash
cd reader_agent

# Create virtual environment
python -m venv venv
.\venv\Scripts\Activate.ps1  # or source venv/bin/activate

# Install dependencies (requires ACR122U driver installed)
pip install -r requirements.txt

# Set the API key (use the key from init_system.py output)
$env:DEVICE_API_KEY="dev-api-key-xxxxxxxxxxxxxxxx"  # PowerShell
# or
set DEVICE_API_KEY=dev-api-key-xxxxxxxxxxxxxxxx  # CMD
# or
export DEVICE_API_KEY=dev-api-key-xxxxxxxxxxxxxxxx  # Linux/Mac

# Start the reader agent
python src/main.py
```

---

## ğŸ§ª Test Scenarios

### Test 1: Login to Dashboard

1. Open http://localhost:5173
2. Login with: admin / Admin@123
3. You should see the dashboard with live attendance feed

### Test 2: Create New Employee with NFC Card

1. Login as admin
2. Go to Employees page
3. Click "Add Employee"
4. Fill in employee details
5. The wizard will prompt you to scan an NFC card
6. Tap an NFC card on the ACR122U reader
7. Confirm card assignment
8. Card data will be written to the NFC card
9. Test the card by tapping again - you should see attendance recorded!

### Test 3: Record Attendance (Clock In/Out)

1. Make sure reader agent is running
2. Tap an assigned NFC card on the reader
3. Check the dashboard - you should see real-time updates:
   - Clock IN on first tap
   - Clock OUT on second tap

### Test 4: Manual Card UID Entry (Without Physical Reader)

If you don't have an NFC reader connected:

1. In the Employee Creation Wizard, click "Enter Card UID Manually"
2. Enter a test UID like: `04ABC123456789`
3. Complete the wizard

### Test 5: API Testing

Use the Swagger UI at http://localhost:8000/docs

**Simulate a card tap (requires device API key):**

```bash
curl -X POST "http://localhost:8000/api/v1/attendance-events" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_DEVICE_API_KEY" \
  -d '{
    "card_uid": "04ABC123456789",
    "device_id": "MAIN-GATE-READER",
    "event_timestamp": "2025-12-03T08:00:00Z"
  }'
```

---

## ğŸ”Œ WebSocket Testing

The dashboard uses WebSocket for real-time updates. You can test the WebSocket connection:

```javascript
// In browser console
const ws = new WebSocket('ws://localhost:8000/ws/attendance');
ws.onopen = () => console.log('Connected!');
ws.onmessage = (e) => console.log('Message:', JSON.parse(e.data));
```

---

## ğŸ”§ Troubleshooting

### Backend Issues

**Database errors:**
```bash
cd backend
rm nfc_attendance.db  # Delete existing database
python init_system.py  # Recreate
```

**Missing dependencies:**
```bash
pip install -r requirements.txt
```

### Frontend Issues

**Node modules errors:**
```bash
cd frontend
rm -rf node_modules
npm install
```

### Reader Agent Issues

**No readers found:**
- Install ACR122U drivers
- Plug in the NFC reader
- Check if reader is recognized: `pcsc_scan` (Linux) or check Device Manager (Windows)

**API key errors:**
- Make sure DEVICE_API_KEY environment variable is set
- Use the key generated by init_system.py

**Card not detected:**
- Ensure card is compatible (MIFARE Classic, NTAG, etc.)
- Try holding the card steady on the reader

---

## ğŸ“‹ API Endpoints Summary

| Endpoint | Method | Description | Auth |
|----------|--------|-------------|------|
| `/api/v1/auth/login` | POST | User login | None |
| `/api/v1/employees` | GET | List employees | Bearer Token |
| `/api/v1/employees` | POST | Create employee | HR_ADMIN |
| `/api/v1/employees/{id}/cards` | POST | Issue card | HR_ADMIN |
| `/api/v1/attendance-events` | POST | Record attendance | Device API Key |
| `/api/v1/attendance/summary` | GET | Daily summary | Bearer Token |
| `/api/v1/cards/scan-mode/latest` | GET | Get scanned card | HR_ADMIN |
| `/ws/attendance` | WebSocket | Live updates | None |

---

## ğŸ¯ Expected Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ATTENDANCE WORKFLOW                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [Employee taps NFC card]                                       â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  [ACR122U Reader detects card UID]                             â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  [Reader Agent sends to Backend API]                            â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  [Backend checks: First tap today?]                             â”‚
â”‚         â”‚                                                       â”‚
â”‚    YES  â”‚  NO                                                   â”‚
â”‚    â–¼    â–¼                                                       â”‚
â”‚  [Record  [Record                                               â”‚
â”‚   IN]     OUT]                                                  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  [WebSocket broadcasts to all clients]                          â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  [Dashboard updates in real-time! ğŸ‰]                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Verification Checklist

- [ ] Backend starts without errors
- [ ] Frontend loads and shows login page
- [ ] Can login with admin/Admin@123
- [ ] Dashboard shows live attendance feed
- [ ] Can create new employee
- [ ] Can scan/enter NFC card UID
- [ ] Can assign card to employee
- [ ] Card tap records attendance (IN/OUT)
- [ ] Dashboard updates in real-time via WebSocket
- [ ] Reader agent connects to backend
- [ ] Reader agent detects card taps

